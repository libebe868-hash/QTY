name: 自动更新库存大屏

on:
  workflow_dispatch:
  push:
    paths:
      - data.xlsx

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: 转换并生成 data.json
        run: |
          npm install xlsx
          node -e "
          const XLSX=require('xlsx'),fs=require('fs');
          const wb=XLSX.readFile('data.xlsx');
          let a=[];
          wb.SheetNames.forEach(s=>{
            if(s.includes('空白')||s==='Sheet1')return;
            const rows=XLSX.utils.sheet_to_json(wb.Sheets[s],{header:1,defval:''});
            if(rows.length<2)return;
            const stockCol=rows[0].length-1;
            for(let i=1;i<rows.length;i++){
              const r=rows[i];
              const stock=parseInt(r[stockCol])||0;
              if(stock>0 && r[0]){
                a.push({sheet:s,型号:String(r[0]).trim(),规格:String(r[1]||r[2]||'').trim(),库存:stock});
              }
            }
          });
          a.sort((x,y)=>y.库存-x.库存);
          fs.mkdirSync('data',{recursive:true});
          fs.writeFileSync('data/data.json',JSON.stringify(a,null,2));
          console.log('成功生成 '+a.length+' 条记录');
          "
      - name: 提交
        run: |
          git config user.name bot
          git add data/data.json
          git commit -m "自动更新" && git push || echo "无变化"
