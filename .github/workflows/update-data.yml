name: è‡ªåŠ¨æ›´æ–°åº“å­˜æ•°æ®

on:
  workflow_dispatch:  # æ‰‹åŠ¨è¿è¡ŒæŒ‰é’®
  push:
    paths:
      - 'èºçº¹æŠ¤å¥—/**'  # ä½ çš„ Excel åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ï¼Œæ”¹åŠ¨å°±è§¦å‘ï¼ˆå¯è°ƒæ•´ï¼‰

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: è®¾ç½® Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: è½¬æ¢ Excel åˆ° JSON
        run: |
          # æ‰¾ä½ çš„ Excel æ–‡ä»¶ï¼ˆæ”¯æŒå­æ–‡ä»¶å¤¹ï¼‰
          EXCEL_PATH=$(find . -name "*.xlsx" -path "*/èºçº¹æŠ¤å¥—/*" | head -1)
          if [ -z "$EXCEL_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ° Excel æ–‡ä»¶ï¼è¯·ä¸Šä¼ åˆ°èºçº¹æŠ¤å¥—æ–‡ä»¶å¤¹ã€‚"
            exit 1
          fi
          echo "æ‰¾åˆ°æ–‡ä»¶: $EXCEL_PATH"
          
          # å®‰è£… xlsx å¹¶è½¬æ¢
          npm init -y
          npm install xlsx
          
          node << 'EOF'
          const XLSX = require('xlsx');
          const fs = require('fs');
          const path = require('path');
          try {
            const workbook = XLSX.readFile(process.env.EXCEL_PATH || 'èºçº¹æŠ¤å¥—/åº“å­˜æ˜ç»†.xlsx');
            const sheetName = workbook.SheetNames[0];  // å–ç¬¬ä¸€ä¸ª sheet
            const worksheet = workbook.Sheets[sheetName];
            // è½¬æˆ JSON æ•°ç»„ï¼ˆheader:1 ä¿æŒåŸå§‹è¡Œç»“æ„ï¼Œé€‚åˆä½ çš„ parseAllSheetsï¼‰
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
            // è¿‡æ»¤ç©ºè¡Œ
            const cleanData = jsonData.filter(row => row.length > 0 && row.some(cell => cell !== '' && cell !== null));
            // åˆ›å»º data æ–‡ä»¶å¤¹å¹¶å†™æ–‡ä»¶
            fs.mkdirSync('data', { recursive: true });
            fs.writeFileSync('data/data.json', JSON.stringify(cleanData, null, 2));
            console.log(`âœ… è½¬æ¢æˆåŠŸï¼Sheet: ${sheetName}, æ€»è¡Œ: ${cleanData.length}`);
          } catch (error) {
            console.error('âŒ è½¬æ¢é”™è¯¯:', error.message);
            process.exit(1);
          }
          EOF

      - name: æäº¤ JSON
        run: |
          git config user.name "åº“å­˜è‡ªåŠ¨æ›´æ–° Bot"
          git config user.email "bot@example.com"
          git add data/data.json
          if git diff --staged --quiet; then
            echo "æ— å˜åŒ–"
          else
            git commit -m "ğŸ¤– æ›´æ–°åº“å­˜ JSON (ä» Excel è½¬æ¢) - $(date +'%Y-%m-%d')"
            git push
          fi
