name: 自动更新库存数据（完整数据提取）

on:
  workflow_dispatch:
  push:
    paths:
      - '**/*.xlsx'

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: 提取所有Sheet完整数据
        run: |
          EXCEL=$(find . -name "*.xlsx" | head -1)
          echo "找到 Excel: $EXCEL"
          
          npm init -y > /dev/null
          npm install xlsx > /dev/null
          
          node <<'EOF'
          const XLSX = require('xlsx');
          const fs = require('fs');
          const path = process.env.EXCEL || '$EXCEL';
          
          const workbook = XLSX.readFile(path);
          let allSheetsData = {};
          
          workbook.SheetNames.forEach(sheetName => {
            const sheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
            
            // 只过滤完全空行（保留所有非空行，包括标题）
            const cleanData = jsonData.filter(row => row.length > 0 && row.some(cell => cell !== '' && cell !== null));
            
            allSheetsData[sheetName] = cleanData;
            console.log(`Sheet "${sheetName}": ${cleanData.length} 行`);
          });
          
          fs.mkdirSync('data', { recursive: true });
          fs.writeFileSync('data/data.json', JSON.stringify(allSheetsData, null, 2));
          
          console.log(`总sheet: ${Object.keys(allSheetsData).length}`);
          console.log('第一个sheet预览:', JSON.stringify(allSheetsData[Object.keys(allSheetsData)[0]]?.slice(0, 3) || '无数据'));
          EOF

      - name: 提交
        run: |
          git config user.name "库存机器人"
          git config user.email "bot@github.com"
          git add data/data.json
          git diff --staged --quiet || (git commit -m "更新完整JSON $(date)" && git push)
