name: æ¯æ—¥è‡ªåŠ¨æ›´æ–°åº“å­˜æ•°æ®

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ10:00è‡ªåŠ¨è¿è¡Œï¼ˆå¯æ”¹ï¼‰
  push:
    paths:
      - 'stock.xlsx'  # åªåœ¨ stock.xlsx å˜åŒ–æ—¶è§¦å‘

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: è½¬æ¢ stock.xlsx â†’ data.jsonï¼ˆé€‚é…ä½ çš„å¤šsheetç»“æ„ï¼‰
        run: |
          # æ£€æŸ¥æ–‡ä»¶å­˜åœ¨
          if [ ! -f "stock.xlsx" ]; then
            echo "âŒ æ‰¾ä¸åˆ° stock.xlsxï¼è¯·ä¸Šä¼ åˆ°æ ¹ç›®å½•ã€‚"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ° stock.xlsxï¼Œå¼€å§‹è½¬æ¢â€¦"

          npm install xlsx

          node -e "
          const XLSX = require('xlsx');
          const fs = require('fs');
          const wb = XLSX.readFile('stock.xlsx');
          let inventoryList = [];

          wb.SheetNames.forEach(sheetName => {
            // è·³è¿‡ç©ºç™½å’Œç©º sheet
            if (sheetName.includes('ç©ºç™½') || sheetName === 'Sheet1') return;

            const ws = wb.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});

            if (rows.length < 2) return;  // å°‘äºæ ‡é¢˜+1è¡Œè·³è¿‡

            // ä½ çš„è¡¨æ ¼ï¼šæœ€åä¸€åˆ—æ˜¯'ç°åº“å­˜'
            const header = rows[0];
            const stockColIndex = header.length - 1;  // å›ºå®šæœ€åä¸€åˆ—ä¸ºåº“å­˜

            for (let i = 1; i < rows.length; i++) {
              const row = rows[i];
              if (!row || row.length < 2) continue;

              const model = String(row[0] || '').trim();  // ç¬¬ä¸€åˆ—ï¼šå‹å·
              if (!model || model === '') continue;

              const stock = parseInt(row[stockColIndex]) || 0;  // æœ€åä¸€åˆ—ï¼šç°åº“å­˜
              if (stock <= 0) continue;  // åªä¿ç•™æœ‰åº“å­˜çš„

              inventoryList.push({
                sheet: sheetName.trim(),
                å‹å·: model,
                è§„æ ¼: String(row[1] || row[2] || row[3] || '').trim(),  // è§„æ ¼åˆ—ï¼ˆç¬¬2-4åˆ—åˆå¹¶ï¼‰
                åº“å­˜: stock
              });
            }
            console.log('Sheet \"' + sheetName + '\": æå– ' + (inventoryList.length - inventoryList.length + inventoryList.filter(item => item.sheet === sheetName.trim()).length) + ' æ¡è®°å½•');
          });

          // å…¨å±€æŒ‰åº“å­˜é™åºæ’åº
          inventoryList.sort((a, b) => b.åº“å­˜ - a.åº“å­˜);

          // å†™å…¥ data.json
          fs.mkdirSync('data', {recursive: true});
          fs.writeFileSync('data/data.json', JSON.stringify(inventoryList, null, 2));

          console.log('âœ… è½¬æ¢å®Œæˆï¼æ€»è®¡ ' + inventoryList.length + ' æ¡æœ‰åº“å­˜è®°å½•');
          console.log('Top 3 ç¤ºä¾‹:');
          inventoryList.slice(0,3).forEach(item => console.log('  - ' + item.å‹å· + ' (' + item.sheet + '): ' + item.åº“å­˜));
          "

      - name: æäº¤ data.json
        run: |
          git config user.name "åº“å­˜è‡ªåŠ¨æ›´æ–° Bot"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/data.json
          if git diff --staged --quiet; then
            echo "æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°åº“å­˜æ•°æ® - $(date +'%Y-%m-%d %H:%M')"
            git push
          fi
