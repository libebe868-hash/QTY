name: è‡ªåŠ¨æ›´æ–°åº“å­˜æ•°æ®

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - '**/*.xlsx'  # ä»»ä½• Excel æ”¹åŠ¨éƒ½è§¦å‘

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: æŸ¥æ‰¾å¹¶è½¬æ¢ Excel
        run: |
          # è‡ªåŠ¨æ‰¾ä»“åº“é‡Œç¬¬ä¸€ä¸ª .xlsx æ–‡ä»¶ï¼ˆä½ çš„èºçº¹æŠ¤å¥—/åº“å­˜æ˜ç»†.xlsxï¼‰
          EXCEL_FILE=$(find . -name "*.xlsx" | head -1)
          if [ -z "$EXCEL_FILE" ]; then
            echo "âŒ ä»“åº“æ—  Excel æ–‡ä»¶ï¼è¯·ä¸Šä¼ åº“å­˜æ˜ç»†.xlsx"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ° Excel: $EXCEL_FILE"

          # å®‰è£…ä¾èµ–
          npm init -y > /dev/null 2>&1
          npm install xlsx@0.18.5 > /dev/null 2>&1

          # Node è½¬æ¢è„šæœ¬
          node -e "
          const XLSX = require('xlsx');
          const fs = require('fs');
          const path = require('path');
          const excelPath = process.env.EXCEL_FILE || '$EXCEL_FILE';
          try {
            const workbook = XLSX.readFile(excelPath);
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
            // è¿‡æ»¤æ ‡é¢˜è¡Œå’Œç©ºè¡Œï¼ˆslice(1) è·³è¿‡æ ‡é¢˜ï¼‰
            const cleanData = jsonData.slice(1).filter(row => row.length > 1 && row.some(cell => cell && cell.toString().trim() !== ''));
            // ç¡®ä¿ data æ–‡ä»¶å¤¹
            fs.mkdirSync('data', { recursive: true });
            fs.writeFileSync('data/data.json', JSON.stringify(cleanData, null, 2));
            console.log('âœ… è½¬æ¢æˆåŠŸï¼Sheet: ' + sheetName + ', æœ‰æ•ˆè¡Œæ•°: ' + cleanData.length);
            console.log('å‰2è¡Œé¢„è§ˆ: ' + JSON.stringify(cleanData.slice(0, 2)));
          } catch (error) {
            console.error('âŒ è½¬æ¢å¤±è´¥: ' + error.message);
            process.exit(1);
          }
          "

      - name: æäº¤æ›´æ–°
        run: |
          git config user.name "åº“å­˜ Bot"
          git config user.email "bot@users.noreply.github.com"
          git add data/data.json
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° data.json (ä» Excel è½¬æ¢) - $(date +'%Y-%m-%d %H:%M')"
            git push
          else
            echo "æ— å˜åŒ–ï¼Œè·³è¿‡"
          fi
